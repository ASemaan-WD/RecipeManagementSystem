# Prisma Model Skill

> This skill defines the canonical conventions for defining models, enums, relations, and indexes in the Prisma schema. All database structure changes must follow these patterns for consistency, performance, and compatibility with the NextAuth adapter.

---

## File Location

- **Schema file:** `prisma/schema.prisma`
- **Migrations:** `prisma/migrations/` (auto-generated by `npx prisma migrate dev`)
- **Generated client output:** `src/generated/prisma` (configured in generator block)

---

## Schema Structure (Section Order)

The schema file follows this exact section order:

```prisma
// 1. Generator configuration
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

// 2. Datasource configuration
datasource db {
  provider = "postgresql"
}

// 3. Enums (grouped, with section comment)
// ─── ENUMS ───

// 4. Models (grouped, with section comment)
// ─── MODELS ───
// Order: Auth models (User, Account, Session, VerificationToken) first,
//        then core domain models, then supporting/join models
```

---

## Naming Conventions

| Element        | Convention               | Example                                     |
| -------------- | ------------------------ | ------------------------------------------- |
| Model name     | `PascalCase`, singular   | `Recipe`, `UserRecipeTag`, `ShoppingList`   |
| Field name     | `camelCase`              | `authorId`, `createdAt`, `isPrimary`        |
| Enum name      | `PascalCase`             | `Difficulty`, `Visibility`, `TagStatus`     |
| Enum value     | `UPPER_SNAKE_CASE`       | `EASY`, `TO_TRY`, `AI_GENERATED`            |
| Relation name  | `camelCase`, descriptive | `author`, `recipes`, `sharedWithMe`         |
| Index          | Implicit (via `@@index`) | `@@index([authorId])`                       |
| Table mapping  | `snake_case`, plural     | `@@map("users")`, `@@map("accounts")`       |
| Column mapping | `snake_case`             | `@map("user_id")`, `@map("email_verified")` |

### Table Mapping Rules

- **Auth models** (NextAuth adapter requirement): Map to snake_case plural (`@@map("users")`, `@@map("accounts")`, `@@map("sessions")`, `@@map("verification_tokens")`)
- **Domain models**: Do NOT add `@@map()` — let Prisma use the PascalCase model name as the table name. This is the established pattern in the current schema.

---

## Model Template

```prisma
model ModelName {
  // ─── Primary Key ───
  id        String   @id @default(cuid())

  // ─── Scalar Fields ───
  name      String
  optional  String?
  withDefault Boolean @default(false)
  numeric   Int      @default(0)
  jsonField Json?

  // ─── Relations (parent) ───
  parent    ParentModel @relation(fields: [parentId], references: [id], onDelete: Cascade)
  parentId  String

  // ─── Relations (children) ───
  children  ChildModel[]

  // ─── Timestamps ───
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ─── Indexes ───
  @@index([parentId])
  @@unique([field1, field2])
}
```

---

## Pattern Details

### Primary Keys

- Always `String` type with `@id @default(cuid())`.
- Always named `id`.
- Never use auto-increment integers — CUIDs are URL-safe and non-sequential.

```prisma
id String @id @default(cuid())
```

### Field Types

| Prisma Type | Usage                    | Example                              |
| ----------- | ------------------------ | ------------------------------------ |
| `String`    | Text fields, IDs, URLs   | `name String`                        |
| `String?`   | Optional text            | `description String?`                |
| `Int`       | Whole numbers            | `servings Int?`                      |
| `Float`     | Decimal numbers          | `avgRating Float?`                   |
| `Boolean`   | True/false flags         | `isPrimary Boolean @default(false)`  |
| `DateTime`  | Timestamps               | `createdAt DateTime @default(now())` |
| `Json`      | Flexible structured data | `nutritionData Json?`                |
| `Enum`      | Fixed set of values      | `difficulty Difficulty?`             |

### Timestamps

Every model should include timestamps (except pure join tables without meaningful data):

```prisma
createdAt DateTime @default(now())
updatedAt DateTime @updatedAt
```

### Enums

```prisma
enum Difficulty {
  EASY
  MEDIUM
  HARD
}
```

- `PascalCase` enum name.
- `UPPER_SNAKE_CASE` values.
- Define all enums in the `// ─── ENUMS ───` section, before models.
- Import in application code: `import { Difficulty } from '@/generated/prisma/client'`.

### Relations

#### One-to-Many (Parent → Children)

```prisma
// Parent side
model User {
  id      String   @id @default(cuid())
  recipes Recipe[] @relation("AuthoredRecipes")
}

// Child side
model Recipe {
  id       String @id @default(cuid())
  author   User   @relation("AuthoredRecipes", fields: [authorId], references: [id])
  authorId String

  @@index([authorId])
}
```

- Name the relation if a model has multiple relations to the same model (e.g., `@relation("AuthoredRecipes")`).
- Always add `@@index` on the foreign key field.

#### Many-to-Many (via Join Table)

```prisma
model Recipe {
  dietaryTags RecipeDietaryTag[]
}

model DietaryTag {
  id      String             @id @default(cuid())
  name    String             @unique
  recipes RecipeDietaryTag[]
}

model RecipeDietaryTag {
  id           String     @id @default(cuid())
  recipe       Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId     String
  dietaryTag   DietaryTag @relation(fields: [dietaryTagId], references: [id])
  dietaryTagId String

  @@unique([recipeId, dietaryTagId])
}
```

- Always use explicit join tables (not Prisma implicit many-to-many).
- Add `@@unique` constraint to prevent duplicate associations.

### Cascade Deletes

Apply `onDelete: Cascade` when child records should be deleted with the parent:

```prisma
// Recipe children — delete when recipe is deleted
recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

// User children — delete when user is deleted (auth models only)
user User @relation(fields: [userId], references: [id], onDelete: Cascade)
```

**Rules:**

- Recipe-owned records (images, ingredients, steps, tags, shares, comments, ratings): `onDelete: Cascade` on recipe relation.
- Auth models (Account, Session): `onDelete: Cascade` on user relation.
- User-owned records with independent value (UserRecipeTag, SavedRecipe, Rating): No cascade on user — let Prisma default (restrict).

### Indexes

```prisma
// Single column — for foreign keys and frequent WHERE clauses
@@index([authorId])
@@index([recipeId])
@@index([userId])

// Composite — for queries that filter on multiple columns
@@index([visibility, createdAt])
@@index([userId, status])

// Unique constraint — prevents duplicates
@@unique([userId, recipeId])
@@unique([userId, recipeId, status])  // allows multiple statuses per user-recipe
@@unique([recipeId, ingredientId])
```

**When to add indexes:**

- Every foreign key field gets an `@@index`.
- Composite indexes for common query patterns (e.g., "recipes by visibility, newest first").
- `@@unique` for business rule enforcement (e.g., one rating per user per recipe).

### Inline Comments

Use `//` comments for non-obvious field purposes:

```prisma
nutritionData Json?    // cached AI nutrition estimates
avgRating     Float?   // denormalized average rating
quantity      String?  // "2 cups", "1 tbsp" — kept as string for flexibility
duration      Int?     // optional timer in minutes
token         String   @unique @default(cuid()) // unique shareable token
isActive      Boolean  @default(true) // author can revoke
```

### Denormalized Fields

For performance, some computed values are stored directly on the model:

```prisma
model Recipe {
  avgRating   Float? // denormalized average rating
  ratingCount Int    @default(0)
}
```

- Always comment that the field is denormalized.
- Update these fields in the application layer when source data changes (e.g., recalculate `avgRating` when a rating is upserted).

---

## Proof of Pattern

| Element                    | Example in Schema                                     |
| -------------------------- | ----------------------------------------------------- |
| Auth models with `@@map`   | `User @@map("users")`, `Account @@map("accounts")`    |
| Core model with indexes    | `Recipe` with 6 indexes                               |
| Join table with `@@unique` | `RecipeDietaryTag @@unique([recipeId, dietaryTagId])` |
| Multi-status tag           | `UserRecipeTag @@unique([userId, recipeId, status])`  |
| Cascade delete             | `RecipeImage` → `onDelete: Cascade` on recipe         |
| Denormalized field         | `Recipe.avgRating`, `Recipe.ratingCount`              |
| JSON flexible field        | `Recipe.nutritionData Json?`                          |

---

## Anti-Patterns

- **Never** use auto-increment IDs — always CUID for security and URL safety.
- **Never** skip indexes on foreign key fields — queries will be slow.
- **Never** use Prisma implicit many-to-many — always explicit join tables for control.
- **Never** skip `@@unique` constraints on join tables — data integrity depends on them.
- **Never** add `@@map` to domain models — only auth models need table name mapping.
- **Never** use `@db.Text` on domain fields — only on auth adapter fields that require it.
- **Never** forget `onDelete: Cascade` on recipe-child relations — orphaned records are a bug.
- **Never** modify auth models (User, Account, Session, VerificationToken) beyond adding new fields — the NextAuth adapter depends on their structure.
- **Never** skip timestamps (`createdAt`, `updatedAt`) on models with meaningful data.

---

## Checklist

Before committing a schema change:

- [ ] Model name is `PascalCase`, singular
- [ ] Fields are `camelCase`
- [ ] Enum values are `UPPER_SNAKE_CASE`
- [ ] Primary key is `String @id @default(cuid())`
- [ ] Foreign keys have `@@index`
- [ ] Join tables have `@@unique` constraints
- [ ] Child records have `onDelete: Cascade` where appropriate
- [ ] Timestamps (`createdAt`, `updatedAt`) are included
- [ ] Comments explain non-obvious fields
- [ ] Auth models are not modified beyond adding new fields
- [ ] Migration created: `npx prisma migrate dev --name <description>`
- [ ] Client regenerated: `npx prisma generate`
